{% extends 'lynx/base.html' %}
{% load crispy_forms_tags %}

{% block style %}
	<style>
        * {
             box-sizing: border-box;
        }
         .multi-select, .multi-select-plugin {
             display: inline-block;
             position: relative;
        }
         .multi-select > span, .multi-select-plugin > span {
             border: none;
             background: none;
             position: relative;
             padding: 0.25em 0.5em;
             padding-right: 1.5em;
             display: block;
             border: solid 1px #000;
             cursor: default;
        }
         .multi-select > span > .chevron, .multi-select-plugin > span > .chevron {
             display: inline-block;
             transform: rotate(-90deg) scale(1, 2) translate(-50%, 0);
             font-weight: bold;
             font-size: 0.75em;
             position: absolute;
             top: 0.2em;
             right: 0.75em;
        }
         .multi-select > ul, .multi-select-plugin > ul {
             position: absolute;
             list-style: none;
             padding: 0;
             margin: 0;
             left: 0;
             top: 100%;
             min-width: 100%;
             z-index: 1000;
             background: #fff;
             border: 1px solid rgba(0, 0, 0, .15);
             box-shadow: 0 6px 12px rgba(0, 0, 0, .175);
             display: none;
             max-height: 320px;
             overflow-x: hidden;
             overflow-y: auto;
        }
         .multi-select > ul > li, .multi-select-plugin > ul > li {
             white-space: nowrap;
        }
         .multi-select > ul > li.selected > label, .multi-select-plugin > ul > li.selected > label {
             background-color: LightBlue;
        }
         .multi-select > ul > li.focused > label, .multi-select-plugin > ul > li.focused > label {
             background-color: DodgerBlue;
        }
         .multi-select > ul > li > label, .multi-select-plugin > ul > li > label {
             padding: 0.25em 0.5em;
             display: block;
        }
         .multi-select > ul > li > label:focus, .multi-select-plugin > ul > li > label:focus, .multi-select > ul > li > label:hover, .multi-select-plugin > ul > li > label:hover {
             background-color: DodgerBlue;
        }
         .multi-select.in > ul, .multi-select-plugin.in > ul {
             display: block;
        }
         .multi-select-backdrop, .multi-select-plugin-backdrop {
             position: fixed;
             top: 0;
             right: 0;
             bottom: 0;
             left: 0;
             z-index: 900;
        }

	</style>
{% endblock %}

{% block javascript %}
    <script>
        $(document).ready(function() {
            var thisYear = new Date().getFullYear();
            $("#id_note_date_year").val(thisYear);

            //THis javascript function uses an array of 0-11
            var thisMonth = new Date().getMonth() + 1;
            $("#id_note_date_month").val(thisMonth);

            var thisDay = new Date().getDate();
            $("#id_note_date_day").val(thisDay);
        });
    </script>
	<script>
         (function($){
            'use strict';

            const DataStatePropertyName = 'multiselect';
            const EventNamespace = '.multiselect';
            const PluginName = 'MultiSelect';

            var old = $.fn[PluginName];
            $.fn[PluginName] = plugin;
            $.fn[PluginName].Constructor = MultiSelect;
            $.fn[PluginName].noConflict = function () {
                $.fn[PluginName] = old;
                return this;
            };

            // Defaults
            $.fn[PluginName].defaults = {

            };

            // Static members
            $.fn[PluginName].EventNamespace = function () {
                return EventNamespace.replace(/^\./ig, '');
            };
            $.fn[PluginName].GetNamespacedEvents = function (eventsArray) {
                return getNamespacedEvents(eventsArray);
            };

            function getNamespacedEvents(eventsArray) {
                var event;
                var namespacedEvents = "";
                while (event = eventsArray.shift()) {
                    namespacedEvents += event + EventNamespace + " ";
                }
                return namespacedEvents.replace(/\s+$/g, '');
            }

            function plugin(option) {
                this.each(function () {
                    var $target = $(this);
                    var multiSelect = $target.data(DataStatePropertyName);
                    var options = (typeof option === typeof {} && option) || {};

                    if (!multiSelect) {
                        $target.data(DataStatePropertyName, multiSelect = new MultiSelect(this, options));
                    }

                    if (typeof option === typeof "") {
                        if (!(option in multiSelect)) {
                            throw "MultiSelect does not contain a method named '" + option + "'";
                        }
                        return multiSelect[option]();
                    }
                });
            }

            function MultiSelect(element, options) {
                this.$element = $(element);
                this.options = $.extend({}, $.fn[PluginName].defaults, options);
                this.destroyFns = [];

                this.$toggle = this.$element.children('.toggle');
                this.$toggle.attr('id', this.$element.attr('id') + 'multi-select-label');
                this.$backdrop = null;
                this.$allToggle = null;

                init.apply(this);
            }

            MultiSelect.prototype.open = open;
            MultiSelect.prototype.close = close;

            function init() {
                this.$element
                .addClass('multi-select')
                .attr('tabindex', 0);

                initAria.apply(this);
                initEvents.apply(this);
                updateLabel.apply(this);
                injectToggleAll.apply(this);

                this.destroyFns.push(function() {
                    return '|'
                });
            }

            function injectToggleAll() {
                if(this.$allToggle && !this.$allToggle.parent()) {
                    this.$allToggle = null;
                }

                this.$allToggle = $("<li><label><input type='checkbox'/>(all)</label><li>");

                this.$element
                .children('ul:first')
                .prepend(this.$allToggle);
            }

            function initAria() {
                this.$element
                .attr('role', 'combobox')
                .attr('aria-multiselect', true)
                .attr('aria-expanded', false)
                .attr('aria-haspopup', false)
                .attr('aria-labeledby', this.$element.attr("aria-labeledby") + " " + this.$toggle.attr('id'));

                this.$toggle
                .attr('aria-label', '');
            }

            function initEvents() {
                var that = this;
                this.$element
                .on(getNamespacedEvents(['click']), function($event) {
                    if($event.target !== that.$toggle[0] && !that.$toggle.has($event.target).length) {
                        return;
                    }

                    if($(this).hasClass('in')) {
                        that.close();
                    } else {
                        that.open();
                    }
                })
                .on(getNamespacedEvents(['keydown']), function($event) {
                    var next = false;
                    var searchString = "", timer;
                    switch($event.keyCode) {
                        case 13:
                            if($(this).hasClass('in')) {
                                that.close();
                            } else {
                                that.open();
                            }
                            break;
                        case 9: //tab
                            if($event.target !== that.$element[0]	) {
                                $event.preventDefault();
                            }
                        case 27:
                            that.close();
                            break;
                        case 40:
                            next = true;
                        case 38:
                            var $items = $(this)
                            .children("ul:first")
                            .find(":input, button, a");

                            var foundAt = $.inArray(document.activeElement, $items);
                            if(next && ++foundAt === $items.length) {
                                foundAt = 0;
                            } else if(!next && --foundAt < 0) {
                                foundAt = $items.length - 1;
                            }

                            $($items[foundAt])
                            .trigger('focus');
                        default:  // Search item starts with

                          // Cancel current timer
                          clearTimeout(timer);

                          // Create search string
                          searchString += $event.key;
                          var self = this;

                          // Set a timer to search item after 500ms
                          timer = setTimeout(function(){
                              // Search item
                              var xpath = "li/span[starts-with(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '" + searchString + "')]";
                              var matchingElement = document.evaluate(xpath, self, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;

                              // Reset search string
                              searchString = "";

                              // If an item is foundâ€¦
                              if (matchingElement) {
                                  currentItem.attr("aria-selected", "false");
                                  $(matchingElement).parent().attr("aria-selected", "true").focus().addClass("active");
                              }
                          }, 500);

                          $event.preventDefault();
                    }
                })
                .on(getNamespacedEvents(['focus']), 'a, button, :input', function() {
                    $(this)
                    .parents('li:last')
                    .addClass('focused');
                })
                .on(getNamespacedEvents(['blur']), 'a, button, :input', function() {
                    $(this)
                    .parents('li:last')
                    .removeClass('focused');
                })
                .on(getNamespacedEvents(['change']), ':checkbox', function() {
                    if(that.$allToggle && $(this).is(that.$allToggle.find(':checkbox'))) {
                        var allChecked = that.$allToggle
                        .find(':checkbox')
                        .prop("checked");

                        that.$element
                        .find(':checkbox')
                        .not(that.$allToggle.find(":checkbox"))
                        .each(function(){
                            $(this).prop("checked", allChecked);
                            $(this)
                            .parents('li:last')
                            .toggleClass('selected', $(this).prop('checked'));
                        });

                        updateLabel.apply(that);
                        return;
                    }

                    $(this)
                    .parents('li:last')
                    .toggleClass('selected', $(this).prop('checked'));

                    var checkboxes = that.$element
                    .find(":checkbox")
                    .not(that.$allToggle.find(":checkbox"))
                    .filter(":checked");

                    that.$allToggle.find(":checkbox").prop("checked", checkboxes.length === checkboxes.end().length);

                    updateLabel.apply(that);
                })
                .on(getNamespacedEvents(['mouseover']), 'ul', function() {
                    $(this)
                    .children(".focused")
                    .removeClass("focused");
                });
            }

            function updateLabel() {
                var pluralize = function(wordSingular, count) {
                    if(count !== 1) {
                        switch(true) {
                            case /y$/.test(wordSingular):
                                wordSingular = wordSingular.replace(/y$/, "ies");
                            default:
                                wordSingular = wordSingular + "s";
                        }
                    }
                    return wordSingular;
                };

                var $checkboxes = this.$element
                .find('ul :checkbox');

                var allCount = $checkboxes.length;
                var checkedCount = $checkboxes.filter(":checked").length
                var label = checkedCount + " " + pluralize("item", checkedCount) + " selected";

                this.$toggle
                .children("label")
                .text(checkedCount ? (checkedCount === allCount ? '(all)' : label) : 'Select a value');

                this.$element
                .children('ul')
                .attr("aria-label", label + " of " + allCount + " " + pluralize("item", allCount));
            }

            function ensureFocus() {
                this.$element
                .children("ul:first")
                .find(":input, button, a")
                .first()
                .trigger('focus')
                .end()
                .end()
                .find(":checked")
                .first()
                .trigger('focus');
            }

            function addBackdrop() {
                if(this.$backdrop) {
                    return;
                }

                var that = this;
                this.$backdrop = $("<div class='multi-select-backdrop'/>");
                this.$element.append(this.$backdrop);

                this.$backdrop
                .on('click', function() {
                    $(this)
                    .off('click')
                    .remove();

                    that.$backdrop = null;
                    that.close();
                });
            }

            function open() {
                if(this.$element.hasClass('in')) {
                    return;
                }

                this.$element
                .addClass('in');

                this.$element
                .attr('aria-expanded', true)
                .attr('aria-haspopup', true);

                addBackdrop.apply(this);
                //ensureFocus.apply(this);
            }

            function close() {
                this.$element
                .removeClass('in')
                .trigger('focus');

                this.$element
                .attr('aria-expanded', false)
                .attr('aria-haspopup', false);

                if(this.$backdrop) {
                    this.$backdrop.trigger('click');
                }
            }
        })(jQuery);

        $(document).ready(function(){
            $('#multi-select-plugin')
            .MultiSelect();
        });
	</script>
{% endblock %}

{% block content %}
<h1>Add New SIP Note</h1>
<br>
<form method="post"> {% csrf_token %}
    <div class="container-fluid">
        <h2>Select Clients</h2>
            <div class="row">
                <div class="col-12">
                <!--              <div class="col-12">{{ form.clients }}</div>-->
                   <div id="multi-select-plugin" aria-label="Select Clients" role="listbox" aria-multiselectable="true">
                        <span class="toggle">
                            <label>Select a value</label>
                            <span class="chevron">&lt;</span>
                        </span>
                        <ul>
                            {% for client in client_list %}
                                <li><label><input type="checkbox" name="selected" value="{{ client.id }}"/>{{ client.last_name }}, {{ client.first_name }}</label></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        <h2>Notes</h2>
            <div class="row">
              <div class="col-12">{{ form.note|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-12">{{ form.note_date|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-12">{{ form.class_hours|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-12">{{ form.instructor|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-12">{{ form.sip_plan|as_crispy_field }}</div>
            </div>
        <h2>Services (check all that apply):</h2>
            <div class="row">
              <div class="col-6">{{ form.vision_screening|as_crispy_field }}</div>
              <div class="col-6">{{ form.treatment|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-6">{{ form.at_devices|as_crispy_field }}</div>
              <div class="col-6">{{ form.at_services|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-6">{{ form.independent_living|as_crispy_field }}</div>
              <div class="col-6">{{ form.orientation|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-6">{{ form.communications|as_crispy_field }}</div>
              <div class="col-6">{{ form.dls|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-6">{{ form.support|as_crispy_field }}</div>
              <div class="col-6">{{ form.advocacy|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-6">{{ form.counseling|as_crispy_field }}</div>
              <div class="col-6">{{ form.information|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-6">{{ form.services|as_crispy_field }}</div>
            </div>
        <h2>Method of delivering service (check all that apply):</h2>
            <div class="row">
              <div class="col-6">{{ form.retreat|as_crispy_field }}</div>
              <div class="col-6">{{ form.in_home|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-6">{{ form.seminar|as_crispy_field }}</div>
              <div class="col-6">{{ form.group|as_crispy_field }}</div>
            </div>
            <div class="row">
              <div class="col-6">{{ form.community|as_crispy_field }}</div>
            </div>
        {{ form.errors }}
    </div>
    <input type="submit" value="Submit">
</form>
{% endblock %}


